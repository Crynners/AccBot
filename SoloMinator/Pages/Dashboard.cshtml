@page
@model DashboardModel
@{
    ViewData["Title"] = L["Dashboard_Title"];
    var culture = ViewContext.HttpContext.Items["Culture"] as string ?? "cs";
}

@if (Model.AddressNotFoundAnywhere)
{
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card text-center">
                <div class="card-body py-5">
                    <i class="bi bi-search text-yellow display-1 mb-3"></i>
                    <h4>@L["Dashboard_AddressNotFound"]</h4>
                    <p class="text-secondary mb-4">@L["Dashboard_AddressNotFoundDesc"]</p>

                    <div class="mb-4">
                        <p class="text-secondary small mb-2">@L["Dashboard_CheckedPools"]:</p>
                        <div class="d-flex justify-content-center flex-wrap gap-2">
                            @foreach (var pool in Model.CheckedPools)
                            {
                                <span class="badge bg-secondary">
                                    <i class="bi bi-globe me-1"></i>@pool
                                </span>
                            }
                        </div>
                    </div>

                    <div class="alert alert-info text-start mx-auto" style="max-width: 500px;">
                        <h6 class="mb-2"><i class="bi bi-info-circle me-1"></i>@L["Dashboard_HowToStart"]</h6>
                        <p class="small mb-2">@L["Dashboard_HowToStartDesc"]</p>
                        <ul class="small mb-0">
                            <li><a href="https://solo.ckpool.org" target="_blank">solo.ckpool.org</a></li>
                            <li><a href="https://eusolo.ckpool.org" target="_blank">eusolo.ckpool.org</a></li>
                            <li><a href="https://ausolo.ckpool.org" target="_blank">ausolo.ckpool.org</a></li>
                            <li><a href="https://solo.braiins.com" target="_blank">solo.braiins.com</a></li>
                        </ul>
                    </div>

                    <a href="/@culture/" class="btn btn-primary mt-3">
                        <i class="bi bi-arrow-left me-2"></i>@L["Dashboard_TryAnotherAddress"]
                    </a>
                </div>
            </div>
        </div>
    </div>
}
else if (Model.Registration == null || Model.AllRegistrations.Count == 0)
{
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card text-center">
                <div class="card-body py-5">
                    <i class="bi bi-exclamation-triangle text-yellow display-1 mb-3"></i>
                    <h4>@L["Dashboard_NotFound"]</h4>
                    <p class="text-secondary">@L["Dashboard_NotFoundDesc"]</p>
                    <a href="/@culture/" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-2"></i>@L["Dashboard_TryAnotherAddress"]
                    </a>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
        <div>
            <h2 class="mb-2">
                <i class="bi bi-speedometer2 text-orange me-2"></i>@L["Dashboard_Title"]
            </h2>
            <div class="d-flex flex-wrap align-items-center gap-2">
                <code class="fs-6">@Model.Registration.MiningAddress</code>
                <div class="d-flex align-items-center gap-2">
                    @if (Model.AllRegistrations.Count > 1)
                    {
                        <div class="btn-group" role="group">
                            @foreach (var reg in Model.AllRegistrations)
                            {
                                var isActive = reg.PoolVariant == Model.Pool;
                                <a href="/@culture/Dashboard?address=@Model.Address&pool=@reg.PoolVariant"
                                   class="btn btn-sm @(isActive ? "btn-primary" : "btn-outline-secondary")">
                                    <i class="bi bi-globe me-1"></i>@reg.PoolVariant
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <span class="badge pool-badge rounded-pill">
                            <i class="bi bi-globe me-1"></i>@(Model.Registration.PoolVariant).ckpool.org
                        </span>
                    }
                    <form method="post" asp-page-handler="DiscoverPools" class="d-inline">
                        <input type="hidden" name="Address" value="@Model.Address" />
                        <input type="hidden" name="Pool" value="@Model.Pool" />
                        <button type="submit" class="btn btn-sm btn-outline-secondary"
                                title="@L["Dashboard_DiscoverPools"]"
                                data-bs-toggle="tooltip">
                            <i class="bi bi-search"></i>
                        </button>
                    </form>
                </div>
                @if (Model.Registration.NotificationsEnabled)
                {
                    <span class="badge bg-success rounded-pill">
                        <i class="bi bi-bell-fill me-1"></i>@L["Dashboard_NotificationsOn"]
                    </span>
                }
            </div>
        </div>
        <a href="/@culture/Settings?address=@Model.Address&pool=@Model.Pool" class="btn btn-outline-primary">
            <i class="bi bi-gear me-1"></i> @L["Nav_Settings"]
        </a>
    </div>

    <!-- Pool Discovery Feedback -->
    @if (TempData["PoolDiscoveryMessage"] != null)
    {
        var message = TempData["PoolDiscoveryMessage"]?.ToString();
        var msgType = TempData["PoolDiscoveryType"]?.ToString();
        if (message == "none")
        {
            <div class="alert alert-info d-flex align-items-center mb-4">
                <i class="bi bi-info-circle me-2"></i>
                @L["Dashboard_NoNewPoolsFound"]
            </div>
        }
        else if (!string.IsNullOrEmpty(message))
        {
            var pools = message.Split(',');
            <div class="alert alert-success d-flex align-items-center mb-4">
                <i class="bi bi-check-circle me-2"></i>
                @L["Dashboard_NewPoolsFound"]: @string.Join(", ", pools)
            </div>
        }
    }

    <!-- Telegram Notifications Status -->
    @if (Model.ActiveSubscriptionsCount > 0)
    {
        <div class="d-flex align-items-center gap-2 mb-4 text-secondary">
            <i class="bi bi-telegram text-blue"></i>
            <span>@L["Dashboard_TelegramActive"] <strong class="text-green">@Model.ActiveSubscriptionsCount</strong> @(Model.ActiveSubscriptionsCount == 1 ? L["Dashboard_TelegramChannel"] : L["Dashboard_TelegramChannels"])</span>
        </div>
    }
    else
    {
        <div class="alert alert-warning d-flex align-items-center justify-content-between mb-4">
            <div class="d-flex align-items-center">
                <i class="bi bi-bell-slash me-2 fs-4"></i>
                <div>
                    <strong>@L["Dashboard_TelegramNone"]</strong><br />
                    <small>@L["Dashboard_TelegramSetupHint"]</small>
                </div>
            </div>
            <a href="/@culture/Settings?address=@Model.Address&pool=@Model.Pool" class="btn btn-warning btn-sm">
                <i class="bi bi-telegram me-1"></i>@L["Dashboard_SetupTelegram"]
            </a>
        </div>
    }

    @if (Model.Stats == null)
    {
        <div class="alert alert-warning d-flex align-items-center">
            <i class="bi bi-cloud-slash me-2 fs-4"></i>
            <div>
                <strong>@L["Dashboard_StatsError"]</strong><br />
                <small>@L["Dashboard_StatsErrorDesc"]</small>
            </div>
        </div>
    }
    else
    {
        <!-- Main Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-lg-4 col-md-6">
                <div class="card card-stat h-100">
                    <div class="card-body text-center py-4">
                        <div class="stat-label">
                            <i class="bi bi-lightning-charge me-1"></i>@L["Dashboard_BestShareSession"]
                        </div>
                        <div class="stat-value text-orange">@FormatShare(Model.Stats.BestShare)</div>
                        @if (Model.CurrentDifficulty.HasValue && Model.Stats.BestShare > 0)
                        {
                            var percentage = (Model.Stats.BestShare / Model.CurrentDifficulty.Value) * 100;
                            <div class="mt-2">
                                <div class="progress-bar-custom">
                                    <div class="progress-bar-fill" style="width: @Math.Min(percentage, 100).ToString(System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                </div>
                                <small class="text-secondary">@FormatPercentage(percentage) @L["Dashboard_OfDifficulty"]</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card card-stat h-100">
                    <div class="card-body text-center py-4">
                        <div class="stat-label">
                            <i class="bi bi-trophy me-1"></i>@L["Dashboard_BestShareEver"]
                        </div>
                        <div class="stat-value text-green">@FormatShare(Model.Stats.BestEver)</div>
                        @if (Model.CurrentDifficulty.HasValue && Model.Stats.BestEver > 0)
                        {
                            var percentage = (Model.Stats.BestEver / Model.CurrentDifficulty.Value) * 100;
                            <div class="mt-2">
                                <div class="progress-bar-custom">
                                    <div class="progress-bar-fill" style="width: @Math.Min(percentage, 100).ToString(System.Globalization.CultureInfo.InvariantCulture)%"></div>
                                </div>
                                <small class="text-secondary">@FormatPercentage(percentage) @L["Dashboard_OfDifficulty"]</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card card-stat h-100">
                    <div class="card-body text-center py-4">
                        <div class="stat-label">
                            <i class="bi bi-boxes me-1"></i>@L["Dashboard_TotalShares"]
                        </div>
                        <div class="stat-value text-blue">@Model.Stats.Shares.ToString("N0")</div>
                        <small class="text-secondary mt-2 d-block">
                            <i class="bi bi-people me-1"></i>@Model.Stats.Workers @L["Dashboard_ActiveWorkers"]
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hashrate Card -->
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-speedometer me-2 text-blue"></i>
                <strong>@L["Dashboard_Hashrate"]</strong>
            </div>
            <div class="card-body">
                <div class="row text-center g-3">
                    <div class="col">
                        <div class="stat-label">1 min</div>
                        <div class="fw-bold fs-5">@FormatHashrateString(Model.Stats.Hashrate1m)</div>
                    </div>
                    <div class="col">
                        <div class="stat-label">5 min</div>
                        <div class="fw-bold fs-5">@FormatHashrateString(Model.Stats.Hashrate5m)</div>
                    </div>
                    <div class="col">
                        <div class="stat-label">1 hour</div>
                        <div class="fw-bold fs-5 text-blue">@FormatHashrateString(Model.Stats.Hashrate1hr)</div>
                    </div>
                    <div class="col">
                        <div class="stat-label">1 day</div>
                        <div class="fw-bold fs-5">@FormatHashrateString(Model.Stats.Hashrate1d)</div>
                    </div>
                    <div class="col">
                        <div class="stat-label">7 days</div>
                        <div class="fw-bold fs-5">@FormatHashrateString(Model.Stats.Hashrate7d)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bitcoin Difficulty -->
        @if (Model.DifficultyInfo != null)
        {
            <div class="card mb-4">
                <div class="card-header d-flex align-items-center">
                    <i class="bi bi-currency-bitcoin me-2 text-yellow"></i>
                    <strong>@L["Dashboard_BitcoinNetwork"]</strong>
                </div>
                <div class="card-body">
                    <div class="row text-center g-3">
                        <div class="col-6 col-md-3">
                            <div class="stat-label">@L["Dashboard_CurrentDifficulty"]</div>
                            <div class="fw-bold fs-5 text-yellow">@FormatDifficulty(Model.CurrentDifficulty ?? 0)</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-label">@L["Dashboard_Progress"]</div>
                            <div class="fw-bold fs-5">@Model.DifficultyInfo.ProgressPercent.ToString("F1") %</div>
                            <div class="progress-bar-custom mt-1">
                                <div class="progress-bar-fill" style="width: @Model.DifficultyInfo.ProgressPercent.ToString(System.Globalization.CultureInfo.InvariantCulture)%"></div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-label">@L["Dashboard_EstChange"]</div>
                            <div class="fw-bold fs-5 @(Model.DifficultyInfo.DifficultyChange >= 0 ? "text-danger" : "text-green")">
                                @(Model.DifficultyInfo.DifficultyChange >= 0 ? "+" : "")@Model.DifficultyInfo.DifficultyChange.ToString("F2") %
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="stat-label">@L["Dashboard_BlocksLeft"]</div>
                            <div class="fw-bold fs-5">@Model.DifficultyInfo.RemainingBlocks</div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Solo Mining Lottery -->
        @if (Model.ChancePerWeek.HasValue || Model.ExpectedDaysToBlock.HasValue || Model.LastBlockFoundMatch != null)
        {
            <div class="card mb-4">
                <div class="card-header d-flex align-items-center">
                    <i class="bi bi-dice-5 me-2 text-purple"></i>
                    <strong>@L["Dashboard_Lottery"]</strong>
                </div>
                <div class="card-body">
                    <div class="row text-center g-3">
                        @if (Model.UserHashrateValue.HasValue && Model.UserHashrateValue > 0)
                        {
                            <div class="col-6 col-md-3">
                                <div class="stat-label">@L["Dashboard_YourHashrate"]</div>
                                <div class="fw-bold fs-5 text-blue">@FormatHashrateValue(Model.UserHashrateValue.Value)</div>
                            </div>
                        }
                        @if (Model.ChancePerWeek.HasValue)
                        {
                            <div class="col-6 col-md-3">
                                <div class="stat-label">@L["Dashboard_ChancePerWeek"]</div>
                                <div class="fw-bold fs-5 text-blue">@FormatChance(Model.ChancePerWeek.Value)</div>
                            </div>
                        }
                        @if (Model.ChancePerYear.HasValue)
                        {
                            <div class="col-6 col-md-3">
                                <div class="stat-label">@L["Dashboard_ChancePerYear"]</div>
                                <div class="fw-bold fs-5 text-green">@FormatChance(Model.ChancePerYear.Value)</div>
                            </div>
                        }
                        @if (Model.ExpectedDaysToBlock.HasValue)
                        {
                            <div class="col-6 col-md-3">
                                <div class="stat-label">@L["Dashboard_ExpectedTime"]</div>
                                <div class="fw-bold fs-5 text-orange">@FormatExpectedTime(Model.ExpectedDaysToBlock.Value)</div>
                            </div>
                        }
                        @if (Model.LastBlockFoundMatch != null)
                        {
                            <div class="col-6 col-md-3">
                                <div class="stat-label">@L["Dashboard_BestShareWouldWin"]</div>
                                <div class="fw-bold fs-5 text-yellow">@Model.LastBlockFoundMatch.Date.ToString("d. M. yyyy")</div>
                                <small class="text-secondary">@L["Dashboard_DifficultyAtDate"] @FormatDifficulty(Model.LastBlockFoundMatch.Difficulty)</small>
                            </div>
                        }
                        else if (Model.Stats?.BestEver > 0)
                        {
                            <div class="col-6 col-md-3">
                                <div class="stat-label">@L["Dashboard_BestShareWouldWin"]</div>
                                <div class="fw-bold fs-5 text-secondary">@L["Dashboard_NeverYet"]</div>
                                <small class="text-secondary">@L["Dashboard_BestShareTooLow"]</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Worker Charts -->
        @if (Model.Stats?.Worker != null && Model.Stats.Worker.Count > 1)
        {
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-pie-chart me-2 text-blue"></i>
                                <strong>@L["Dashboard_HashrateDistribution"]</strong>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary active" data-chart="hashrate" data-type="doughnut" title="@L["Dashboard_ChartPie"]">
                                    <i class="bi bi-pie-chart"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-chart="hashrate" data-type="bar" title="@L["Dashboard_ChartBar"]">
                                    <i class="bi bi-bar-chart"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <canvas id="hashrateChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-pie-chart me-2 text-orange"></i>
                                <strong>@L["Dashboard_SharesDistribution"]</strong>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary active" data-chart="shares" data-type="doughnut" title="@L["Dashboard_ChartPie"]">
                                    <i class="bi bi-pie-chart"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" data-chart="shares" data-type="bar" title="@L["Dashboard_ChartBar"]">
                                    <i class="bi bi-bar-chart"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body d-flex justify-content-center align-items-center">
                            <canvas id="sharesChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Workers Table -->
        @if (Model.Stats?.Worker != null && Model.Stats.Worker.Any())
        {
            <div class="card mb-4">
                <div class="card-header d-flex align-items-center">
                    <i class="bi bi-pc-display me-2 text-purple"></i>
                    <strong>@L["Dashboard_Workers"]</strong>
                    <span class="badge bg-secondary ms-2">@Model.Stats.Worker.Count</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr class="text-secondary">
                                    <th class="ps-3">@L["Dashboard_Worker"]</th>
                                    <th class="text-end">@L["Dashboard_Hashrate"]</th>
                                    <th class="text-end">Best Share</th>
                                    <th class="text-end d-none d-md-table-cell">Best Ever</th>
                                    <th class="text-end d-none d-md-table-cell">@L["Dashboard_Shares"]</th>
                                    <th class="text-end pe-3">@L["Dashboard_LastShare"]</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var worker in Model.Stats.Worker.OrderByDescending(w => w.BestShare))
                                {
                                    <tr>
                                        <td class="ps-3">
                                            <code>@GetWorkerDisplayName(worker.WorkerName)</code>
                                        </td>
                                        <td class="text-end text-blue">@FormatHashrateString(worker.Hashrate1hr)</td>
                                        <td class="text-end text-orange">@FormatShare(worker.BestShare)</td>
                                        <td class="text-end text-green d-none d-md-table-cell">@FormatShare(worker.BestEver)</td>
                                        <td class="text-end d-none d-md-table-cell">@worker.Shares.ToString("N0")</td>
                                        <td class="text-end pe-3 text-secondary">@FormatLastShare(worker.LastShare)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
    }
}

@functions {
    string FormatShare(double share)
    {
        if (share >= 1e15) return $"{share / 1e15:F2} P";
        if (share >= 1e12) return $"{share / 1e12:F2} T";
        if (share >= 1e9) return $"{share / 1e9:F2} G";
        if (share >= 1e6) return $"{share / 1e6:F2} M";
        if (share >= 1e3) return $"{share / 1e3:F2} K";
        return share.ToString("F0");
    }

    string FormatDifficulty(double diff)
    {
        if (diff >= 1e12) return $"{diff / 1e12:F2} T";
        if (diff >= 1e9) return $"{diff / 1e9:F2} G";
        return diff.ToString("F0");
    }

    string FormatLastShare(long timestamp)
    {
        if (timestamp == 0) return L["Dashboard_Never"];
        var dt = DateTimeOffset.FromUnixTimeSeconds(timestamp);
        var ago = DateTimeOffset.UtcNow - dt;
        if (ago.TotalMinutes < 1) return L["Dashboard_JustNow"];
        if (ago.TotalMinutes < 60) return $"{(int)ago.TotalMinutes} {L["Dashboard_MinAgo"]}";
        if (ago.TotalHours < 24) return $"{(int)ago.TotalHours} {L["Dashboard_HourAgo"]}";
        return $"{(int)ago.TotalDays} {L["Dashboard_DayAgo"]}";
    }

    string GetWorkerDisplayName(string? fullName)
    {
        if (string.IsNullOrEmpty(fullName)) return "Unknown";
        var parts = fullName.Split('.');
        return parts.Length > 1 ? parts[^1] : fullName;
    }

    string FormatChance(double percentage)
    {
        if (percentage >= 100) return $"{percentage:F1} %";
        if (percentage >= 10) return $"{percentage:F2} %";
        if (percentage >= 1) return $"{percentage:F3} %";
        if (percentage >= 0.01) return $"{percentage:F4} %";
        if (percentage >= 0.0001) return $"{percentage:F6} %";
        if (percentage >= 0.0000001) return $"{percentage:F9} %";
        // For extremely small values, show in scientific notation with %
        return $"{percentage:E2} %";
    }

    string FormatPercentage(double percentage)
    {
        // Format with enough precision but remove trailing zeros
        var formatted = percentage.ToString("0.######", System.Globalization.CultureInfo.InvariantCulture);
        return formatted + " %";
    }

    string FormatHashrateString(string? hashrate)
    {
        if (string.IsNullOrWhiteSpace(hashrate)) return "0";
        hashrate = hashrate.Trim();
        // Check if it already has H/s suffix with space
        if (hashrate.Contains("H/s", StringComparison.OrdinalIgnoreCase)) return hashrate;
        // Check for unit suffix and add space + H/s
        if (hashrate.Length > 0)
        {
            var lastChar = hashrate[^1];
            if (lastChar == 'Z' || lastChar == 'E' || lastChar == 'P' || lastChar == 'T' ||
                lastChar == 'G' || lastChar == 'M' || lastChar == 'K')
            {
                // Insert space before unit if not present
                var numEnd = hashrate.Length - 1;
                var numPart = hashrate[..numEnd].TrimEnd();
                return numPart + " " + lastChar + "H/s";
            }
        }
        return hashrate;
    }

    string FormatExpectedTime(double days)
    {
        if (days < 1) return $"{days * 24:F1} {L["Dashboard_Hours"]}";
        if (days < 7) return $"{days:F1} {L["Dashboard_Days"]}";
        if (days < 30) return $"{days / 7:F1} {L["Dashboard_Weeks"]}";
        if (days < 365) return $"{days / 30:F1} {L["Dashboard_Months"]}";
        if (days < 3650) return $"{days / 365:F1} {L["Dashboard_Years"]}";
        return $"{days / 365:F0} {L["Dashboard_Years"]}";
    }

    string FormatHashrateValue(double hashrate)
    {
        if (hashrate >= 1e21) return $"{hashrate / 1e21:F2} ZH/s";
        if (hashrate >= 1e18) return $"{hashrate / 1e18:F2} EH/s";
        if (hashrate >= 1e15) return $"{hashrate / 1e15:F2} PH/s";
        if (hashrate >= 1e12) return $"{hashrate / 1e12:F2} TH/s";
        if (hashrate >= 1e9) return $"{hashrate / 1e9:F2} GH/s";
        if (hashrate >= 1e6) return $"{hashrate / 1e6:F2} MH/s";
        if (hashrate >= 1e3) return $"{hashrate / 1e3:F2} KH/s";
        return $"{hashrate:F0} H/s";
    }

    double ParseHashrateToNumber(string? hashrate)
    {
        if (string.IsNullOrWhiteSpace(hashrate)) return 0;
        hashrate = hashrate.Trim().ToUpper();
        var numberPart = "";
        var unitPart = "";
        foreach (var c in hashrate)
        {
            if (char.IsDigit(c) || c == '.' || c == ',')
                numberPart += c;
            else if (char.IsLetter(c))
                unitPart += c;
        }
        if (!double.TryParse(numberPart.Replace(',', '.'), System.Globalization.NumberStyles.Any,
            System.Globalization.CultureInfo.InvariantCulture, out var value))
            return 0;
        return unitPart switch
        {
            "Z" or "ZH" or "ZH/S" or "ZHS" => value * 1e21,
            "E" or "EH" or "EH/S" or "EHS" => value * 1e18,
            "P" or "PH" or "PH/S" or "PHS" => value * 1e15,
            "T" or "TH" or "TH/S" or "THS" => value * 1e12,
            "G" or "GH" or "GH/S" or "GHS" => value * 1e9,
            "M" or "MH" or "MH/S" or "MHS" => value * 1e6,
            "K" or "KH" or "KH/S" or "KHS" => value * 1e3,
            _ => value
        };
    }
}

@if (Model.Stats != null && Model.Registration != null)
{
    <!-- Save valid address to recent list -->
    <script>
    (function() {
        const COOKIE_NAME = 'solominator_addresses';
        const MAX_ADDRESSES = 5;
        const address = '@Model.Registration.MiningAddress';

        function getBaseDomain() {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || /^\d+\.\d+\.\d+\.\d+$/.test(hostname)) {
                return hostname;
            }
            return '.' + hostname.replace(/^www\./, '');
        }

        function getRecentAddresses() {
            try {
                const match = document.cookie.match(new RegExp('(^| )' + COOKIE_NAME + '=([^;]+)'));
                if (match) {
                    return JSON.parse(decodeURIComponent(match[2]));
                }
                return [];
            } catch {
                return [];
            }
        }

        function saveRecentAddresses(addresses) {
            try {
                const domain = getBaseDomain();
                const value = encodeURIComponent(JSON.stringify(addresses));
                const expires = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toUTCString();
                document.cookie = `${COOKIE_NAME}=${value}; expires=${expires}; path=/; domain=${domain}; SameSite=Lax`;
            } catch {}
        }

        // Add address to recent list
        if (address) {
            let addresses = getRecentAddresses();
            addresses = addresses.filter(a => a.address !== address);
            addresses.unshift({ address: address, timestamp: Date.now() });
            addresses = addresses.slice(0, MAX_ADDRESSES);
            saveRecentAddresses(addresses);
        }
    })();
    </script>
}

@if (Model.Stats?.Worker != null && Model.Stats.Worker.Count > 1)
{
    @section Scripts {
    <script>
    (function() {
        const chartColors = [
            '#f78166', '#3fb950', '#58a6ff', '#a371f7', '#d29922',
            '#f85149', '#56d364', '#79c0ff', '#bc8cff', '#e3b341'
        ];

        const workerData = [
            @foreach (var worker in Model.Stats.Worker)
            {
                var name = GetWorkerDisplayName(worker.WorkerName);
                var hashrate = ParseHashrateToNumber(worker.Hashrate1hr);
                var shares = worker.Shares;
                @:{ name: "@Html.Raw(name)", hashrate: @hashrate.ToString(System.Globalization.CultureInfo.InvariantCulture), shares: @shares },
            }
        ];

        // Convert hashrate to TH/s for display
        const workerDataForChart = workerData.map(w => ({
            ...w,
            hashrateTH: w.hashrate / 1e12
        }));

        // Sort by hashrate/shares descending for charts
        const workerDataByHashrate = [...workerDataForChart].sort((a, b) => b.hashrateTH - a.hashrateTH);
        const workerDataByShares = [...workerDataForChart].sort((a, b) => b.shares - a.shares);

        const charts = {};

        function createChart(canvasId, type, sortedWorkerData, valueKey) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;

            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }

            const isBar = type === 'bar';
            const isHashrate = valueKey === 'hashrateTH';
            const unit = isHashrate ? ' TH/s' : '';

            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: sortedWorkerData.map(w => w.name),
                    datasets: [{
                        data: sortedWorkerData.map(w => w[valueKey]),
                        backgroundColor: chartColors,
                        borderColor: isBar ? chartColors : '#161b22',
                        borderWidth: isBar ? 1 : 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: isBar ? 'y' : undefined,
                    plugins: {
                        legend: {
                            display: !isBar,
                            position: 'bottom',
                            labels: { color: '#e6edf3', padding: 10, font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = isHashrate ? context.raw.toFixed(2) : context.raw.toLocaleString();
                                    return context.label + ': ' + value + unit;
                                }
                            }
                        }
                    },
                    scales: isBar ? {
                        x: {
                            ticks: {
                                color: '#8b949e',
                                callback: function(value) {
                                    return isHashrate ? value.toFixed(1) + unit : value;
                                }
                            },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            ticks: { color: '#e6edf3' },
                            grid: { color: '#30363d' }
                        }
                    } : {}
                }
            });
            return charts[canvasId];
        }

        // Initial charts
        createChart('hashrateChart', 'doughnut', workerDataByHashrate, 'hashrateTH');
        createChart('sharesChart', 'doughnut', workerDataByShares, 'shares');

        // Toggle buttons
        document.querySelectorAll('[data-chart][data-type]').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartName = this.dataset.chart;
                const chartType = this.dataset.type;
                const canvasId = chartName + 'Chart';
                const sortedData = chartName === 'hashrate' ? workerDataByHashrate : workerDataByShares;
                const valueKey = chartName === 'hashrate' ? 'hashrateTH' : 'shares';

                createChart(canvasId, chartType, sortedData, valueKey);

                // Update active state
                this.closest('.btn-group').querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
    })();
    </script>
    }
}

